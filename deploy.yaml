# deploy.yaml
---
- name: "Installation site Web complet avec docker compose"
  hosts: web
  become: true
  vars:
    app_directory: /home/efcs
  vars_files:
    - ./vars/secret-variables.yaml
  pre_tasks:
    - name: INSTALL DEPENDANCES DOCKER
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present
        update_cache: yes
      tags: docker

    - name: AJOUT CLE GPG DE DOCKER
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: docker

    - name: AJOUT DEPOT APT DE DOCKER
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
        state: present
      tags: docker

  tasks:
    - name: INSTALL DOCKER
      apt:
        name: docker-ce
        state: present
        update_cache: yes
      tags: docker

    - name: DEMARRE DOCKER
      ansible.builtin.systemd_service:
        state: started
        name: docker
      tags: docker

    - name: Creer reportoire de base
      ansible.builtin.file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0755'
      tags: directories

    - name: Créer repertoire 'vars'
      ansible.builtin.file:
        path: "{{ app_directory }}/vars"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0755'
      tags: directories

    - name: Créer repertoire 'conf'
      ansible.builtin.file:
        path: "{{ app_directory }}/conf"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0755'
      tags: directories

    - name: Créer repertoire 'html'
      ansible.builtin.file:
        path: "{{ app_directory }}/html"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0775'
      tags: directories

    - name: Créer repertoire 'php'
      ansible.builtin.file:
        path: "{{ app_directory }}/php"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0775'
      tags: directories

    - name: Copier compose.yaml
      ansible.builtin.template:
        src: files/docker-compose/compose.yaml
        dest: "{{ app_directory }}/compose.yaml"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'
      notify: restart compose
      tags: copy

    - name: copier default.conf
      ansible.builtin.copy:
        src: files/docker-compose/conf/default.conf
        dest: "{{ app_directory }}/conf/default.conf"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'
      notify: restart compose
      tags: copy

    - name: copier index.php
      ansible.builtin.copy:
        src: files/docker-compose/html/index.php
        dest: "{{ app_directory }}/html/index.php"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'
      notify: restart compose
      tags: copy

    - name: copier dockerfile
      ansible.builtin.copy:
        src: files/docker-compose/php/Dockerfile
        dest: "{{ app_directory }}/php/Dockerfile"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'
      notify: restart compose
      tags: copy

    - name: copier secret-variables
      ansible.builtin.copy:
        src: vars/secret-variables.yaml
        dest: "{{ app_directory }}/vars/secret-variables.yaml"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'
      notify: restart compose
      tags: copy

    - name: Stopper les conteneurs Docker
      ansible.builtin.command: docker compose down
      args:
        chdir: "{{ app_directory }}"
      become: true
      tags:
        - stop

  handlers:
    - name: restart compose
      ansible.builtin.command: docker compose up -d --build --force-recreate
      args:
        chdir: "{{ app_directory }}"
